![[Pasted image 20240725144754.png]]
- `provider_access_token`
- `suite_access_token`
- `access_token`


# 接口调用许可

```ad-faq
企业微信通过向服务商开放接口，实现企业微信与服务商产品之间的相互调用，一起满足企业在各应用场景下的使用需求。为了确保服务商正确与规范的使用接口，企业微信向服务商颁发接口调用许可。

服务商在获得调用许可并在企业管理员授权后，可将账号激活码绑定到企业成员，以激活基于该成员调用企业微信接口的能力。

开通接口调用许可时，服务商向企业微信支付许可费用，同时取消现有的按照收款资金固定比例收取的“技术服务费”。

许可账号，也即接口调用许可账号，按照能力的不同，分为两种类型：`基础账号`与`互通账号`。  
服务商为企业提供服务时，至少需要为企业成员开通基础账号，才能为该成员调用身份验证、应用发消息等接口。  
服务商为企业提供微信客户联系相关的功能时，需要为企业成员开通互通账号。开通了互通账号，自动拥有了基础账号的能力。  
下文中，如无特殊说明，`接口调用许可账号`将简称为`许可账号`，或者`账号`。
```
- 企学院中的账号没有提供微信客户联系功能, 都是基础账号
- 客户下单后, 
	- 新增购买: 企学院根据人头向企业微信购买新的基础账号, 返回一批账号激活码列表
	- 续费: 企学院向企业微信为一批已激活的账号的成员续约, 返回续期账号的成员列表
- 激活账号, 将某个激活码绑定到某个客户企业员工上
- 账号集成: 企业员工离职或工作范围变动时, 可以将账号继承给其他员工


# 脚本

### 自动激活快过期的 licence - ScrmAutoActive
- 定期任务, 默认 10 mins 一次
- 拿锁
- 拿快过期的所有 licence (未过期, 两周内会过期)
- 分组, `corp_id -> suite_id -> licences`
- 循环处理每一组, 组内数据调用 `licence.AutoBatchActive()` 批量激活组内的 licences
- 过滤无法激活的 licences
- 拿到该商家可用的激活码, 按照 待激活, 待转移分成两组 `GetActiveLicencesGrouped`
- 可用激活码数量少于需要进行自动激活
- 优先使用 `待激活` 的可用 licence 去用于续期
- 如果还不够就尝试使用 `待转移` 的可用 licence 去用于剩余部分的续约 ==就是这里造成了可能会漏激活??? 为什么拿可用待转移激活码的时候不添加 last_trans_time 超过了 30 天条件以保证所有拿到的待转移 licences 都是可转移的==
- `待转移` 的 licence 受到企微 30 天内只能转移一次的限制因此不一定会成功
- 请求企微 api 进行激活或者转移
- 处理结果


### 自动重新激活已过期而且用户还在可见范围, 还需要继续使用的 licence - AutoReneWalExpiredLicence
- 捞出满足需求的 `licences`
- 调用 `AutoBatchActive()` 去授权
- 如果授权失败, 就将用户设置为未授权


### 自动释放不可用学员限制 AutoReleaseUnavailableUser
- `db_wework_base.t_qw_unavailable_user` 表记录了所有 `licence_status == 40` (因为各种原因), 且还在应用可见范围, 且上次转移时间没超过 30 天的 `licence-qw_uid`
- 捞出所有满足释放条件的记录 `release_time < time.Now()`
- 改表释放


# AutoMarkInvoiceStatus
- 疑似跟发票有关, TODO
