- 事务: 将几个串行的分步任务作为一个不可分割的整体 `事务` 去执行, 要不然就全部执行, 要不然就全部都不执行(回滚)
- 事务特性
	- 原子性: undo log
	- 一致性: 事务前后数据库满足完整性约束(主键, 唯一, 外键, 默认, 检查...)
	- 隔离性: 事务互不干扰: MVCC 或锁机制
	- 持久性: 事务对数据库的修改是永久的: redo log
- 并发事务 (隔离性的问题):
	- 脏读: 未提交事务修改的内容(可能回滚或后续修改导致错误)
	- 不可重复读: 一个事务内, 读同一个记录得到不同的结果 (提交事务修改)
	- 幻读: 某一个事务前后两次查询符合条件的 `记录个数`, 前后两次读到的记录个数不一样 (被并发事务删除或增加了), 则出现了 `幻读`, 区别于不可重复度只是记录被修改了
- 事务的隔离级别: 从低到高, 级别越高性能越差
	- 读未提交: 没提交的修改可以被其他事务看到, 直接读最新数据
	- 读提交: 提交后, 修改才能被其他事务看到, 通过创建 `read view` 来进行隔离, 在每一个语句执行之前都会重新生成一个 `read view`
	- 可重复读: InnoDB 的默认级别, 一个事务执行过程中, 读到的数据跟它启动时看到的是一致的, 通过 `read view` 实现, 事务开始时创建, 并在整个事务过程中都使用这一个 `read view`
	- 串行化: 对记录加上读写锁, 多个事务对同一个记录进行读写操作时, 会阻塞等待
- ![[Pasted image 20240521141213.png]]
- Mysql InnoDB 默认是使用可重复读隔离级别, 而且可以很大程度上避免幻读的发生
- 解决幻读
	- 快照读 (普通 select 语句): 使用 MVCC, 
	- 当前读 (select... For update): 使用 `next key lock` (加锁)
- Read view 在 MVCC 中如何工作
- `read view` 结构
- ![[Pasted image 20240521145532.png]]
	- `read view` 创建者的事务 id
	- 创建时, 数据库中还未提交的其他事务
	- 其他事务的最小 id
	- 应该给下一个事务的 id
- 记录的隐藏列
- ![[Pasted image 20240521145901.png]]
	- `trx_id` 标识上一次修改该记录的事务 id
	- `roll_pointer` 每次对某条聚簇索引记录进行改动时，都会把旧版本的记录写入到 undo 日志中，然后**这个隐藏列是个指针，指向每一个旧版本记录**，于是就可以通过它找到修改前的记录。
- ![[Pasted image 20240521150236.png]]
- MCVV: TODO 看熟了
	- 如果记录的 trx_id 值小于 Read View 中的 `min_trx_id` 值，表示这个版本的记录是在创建 Read View **前**已经提交的事务生成的，所以该版本的记录对当前事务**可见**。
	- 如果记录的 trx_id 值大于等于 Read View 中的 `max_trx_id` 值，表示这个版本的记录是在创建 Read View **后**才启动的事务生成的，所以该版本的记录对当前事务**不可见**。
	- 如果记录的 trx_id 值在 Read View 的 `min_trx_id` 和 `max_trx_id` 之间，需要判断 trx_id 是否在 m_ids 列表中：
	    - 如果记录的 trx_id **在** `m_ids` 列表中，表示生成该版本记录的活跃事务依然活跃着（还没提交事务），所以该版本的记录对当前事务**不可见**。
	    - 如果记录的 trx_id **不在** `m_ids` 列表中，表示生成该版本记录的活跃事务已经被提交，所以该版本的记录对当前事务**可见**。
- MVCC 可重复读过程
- MVCC 读提交过程


# 可重复读级别与幻读
- 快照读(普通 select): 使用 read view, 可以有效避免幻读
- 当前读 (除了普通查询之外的其他): 必须获取最新数据, 无法使用 `read view`, 因此可能造成幻读
- 为了解决可重复读级别, 当前读可能造成幻读的情况, 引入了 `间隙锁`
	- 例如:
	- ![[Pasted image 20240521151901.png]]
	- A 执行了这个当前读语句之后, 就在对表上记录加上了 2 之后的 `next-key lock` (间隙锁+记录锁的组合)
	- B 执行后遇到了锁, 从而等待 A 的提交
- 幻读还是可能发生
	- ![[Pasted image 20240521152508.png]]
	- 事务 A 在最开始无法查询到, 但是它可以通过当前读将记录的隐藏列的 `trx_id` 改为自己, 从而后续可以查询到
	- 