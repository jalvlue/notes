# simplebank
[[simplebank-BackendMasterClass]]

### docker
- 传统的虚拟机需要模拟整台机器包括硬件，每台虚拟机都需要有自己的操作系统，虚拟机一旦被开启，预分配给他的资源将全部被占用。每一个虚拟机包括应用，必要的二进制和库，以及一个完整的用户操作系统。
- 容器技术是和我们的宿主机共享硬件资源及操作系统可以实现资源的动态分配。容器包含应用和其所有的依赖包，但是与其他容器**共享内核**。容器在宿主机操作系统中，在用户空间以分离的进程运行。
- Linux Namespaces 机制提供一种 `进程资源隔离` 方案。PID、IPC、Network 等系统资源不再是全局性的，而是属于某个特定的**Namespace**。每个**namespace**下的资源对于其他 **namespace** 下的资源都是透明，不可见的。系统中可以同时存在两个进程号为 0、1、2 的进程，由于属于不同的 namespace，所以它们之间并不冲突。
- Docker 通过 **Cgroup** 来控制容器使用的资源配额，一旦超过这个配额就发出**OOM**。配额主要包括 CPU、内存、磁盘三大方面，基本覆盖了常见的资源配额和使用量控制。
- chroot (change root file system)命令的功能是 **改变进程的根目录到指定的位置**。比如我们现在有一个 `$HOME/test` 目录，想要把它作为一个 `/bin/bash` 进程的根目录。**chroot** 只改变当前进程的 /，**pivot_root**改变当前 **mount namespace**的 / 。**pivot_root** 可以认为是 **chroot** 的改良版。
- 联合文件系统（UnionFS）是一种**分层、轻量级并且高性能的文件系统**，它支持对文件系统的修改作为一次提交来一层层的叠加，同时可以**将不同目录挂载到同一个虚拟文件系统**下。比如现在有水果fruits、蔬菜vegetables两个目录，其中水果中有苹果和蕃茄，蔬菜有胡萝卜和蕃茄：



# MR
### 横向对比 vs Hadoop mapreduce
- 架构: 我是用单体 master+多个 worker, 一次只能处理一个 job, HDMR 使用 `jobtracker+tasktracer`, 可以同时进行多个 job
- HDMR 使用 HDFS 作为底层的文件系统, 在此之上共享存储输入数据的中间计算结果, 我使用本机文件系统
- 性能和优化:
	- HDMR: 在 HDFS 上做了数据局部性处理, job 调度, IO 优化, 并行度调整

### 亮点与难题
- 故障检测


# raft
[[courses/6.5840/papers/Raft|Raft]]

### CAP
CAP 理论是分布式计算领域的理论基础之一，它是由计算机科学家 Eric Brewer 在 2000 年提出的。CAP 理论指的是在分布式系统设计中的三个基本属性：一致性（Consistency）、可用性（Availability）和分区容错性（Partition Tolerance）。

1. 一致性（Consistency）：一致性要求系统的所有节点在同一时间点上看到的数据是一致的。换句话说，对系统的更新操作应该在所有节点上以相同的顺序和结果执行，保持数据的一致性状态。

2. 可用性（Availability）：可用性要求系统在面对用户请求时能够提供正常的响应，即系统必须保持高可用性。即使系统中的某些节点出现故障或不可用，仍然需要尽量保证用户能够访问和使用系统。

3. 分区容错性（Partition Tolerance）：分区容错性是指系统在面对网络分区（节点之间无法通信）的情况下仍然能够继续正常运行。分布式系统通常由多个节点组成，这些节点通过网络进行通信。由于网络故障或其他原因，节点之间可能无法相互通信，这时系统需要继续运行并保持一致性和可用性。

CAP 理论提出了一个重要观点，即在分布式系统中，无法同时满足一致性、可用性和分区容错性这三个属性。根据 CAP 理论，一个分布式系统只能满足其中的两个属性，而无法同时满足三个属性。

根据具体的需求和应用场景，可以根据 CAP 理论来进行设计和权衡。例如，在某些场景下，如金融交易系统，一致性是首要考虑的属性，而在其他场景下，如大规模互联网应用，可用性和分区容错性可能更为重要。

需要注意的是，尽管 CAP 理论指出了在分布式系统中的权衡和限制，但实际的分布式系统设计中还涉及到其他方面的考虑，如性能、可扩展性、数据一致性模型等。


CAP 理论认为在分布式系统中，无法同时满足一致性（Consistency）、可用性（Availability）和分区容错性（Partition Tolerance）这三个属性的原因是因为网络分区（节点之间无法通信）的存在。

当系统发生网络分区时，节点之间无法相互通信，这导致节点无法通过消息传递来达成一致的状态。在这种情况下，系统要么可以选择保持可用性，即继续响应客户端请求，但可能导致不一致的数据；要么可以选择保持一致性，即拒绝服务，直到网络分区恢复并达到一致状态。

具体来说：

- 如果系统要求保持一致性（Consistency）和可用性（Availability），即在面对网络分区时仍然提供一致的数据，那么系统需要拒绝服务，直到网络分区恢复。这是因为要保证一致性，需要节点之间的相互通信和协调，而在网络分区情况下，无法实现这种协调。因此，系统选择保持一致性的同时会牺牲可用性。

- 如果系统要求保持可用性（Availability）和分区容错性（Partition Tolerance），即在面对网络分区时仍然提供正常的响应，那么系统可能会出现不一致的数据。当网络分区发生时，节点之间无法相互通信，各个节点可能会独立地进行更新操作，导致数据的不一致性。这是因为要保证可用性，系统必须继续响应客户端请求，而无法等待网络分区恢复并达到一致状态。

因此，由于网络分区的存在，CAP 理论认为在分布式系统中无法同时满足一致性、可用性和分区容错性这三个属性。系统设计者需要根据具体的需求和应用场景，在这三个属性之间进行权衡和选择。

### raft 使用场景
- 元信息: 配置服务, 分布式协调服务 (etcd)
- 数据赋值: 做为一种冗余的手段

### raft 有哪些性能问题
- 只支持全局快照
- Leader 瓶颈

### 论文提到 Raft 只在非拜占庭的条件下才能正常工作，什么是拜占庭条件？为什么 Raft 会出问题？

“非拜占庭条件”（Non-Byzantine conditions）是指所有的服务器都是“宕机-停止”（ fail stop）模型（更多模型参见[这里]( https://link.juejin.cn?target=https%3A%2F%2Fddia.qtmuniao.com%2F%23%2Fch08%3Fid%3D%25E7%25B3%25BB%25E7%25BB%259F%25E6%25A8%25A1%25E5%259E%258B%25E5%2592%258C%25E7%258E%25B0%25E5%25AE%259E " https://ddia.qtmuniao.com/#/ch08?id=%E7%B3%BB%E7%BB%9F%E6%A8%A1%E5%9E%8B%E5%92%8C%E7%8E%B0%E5%AE%9E" )）：即每个服务器要么严格遵循 Raft 协议，要么停止服务。例如，服务器断电就是一个非拜占庭条件，此时服务器会停止执行指令，则 Raft 也会停止运行，且不会发送错误结果给客户端。


### Raft 在工程中有哪些常见的优化？

由于领导者选举是个低频操作，主要 IO 路径优化还是集中在日志同步流程上。

- **batch**：Leader 每次攒一批再刷盘和对 Follower 进行同步。降低刷盘和 RPC 开销。
- **pipeline**：每次发送日志时类似 TCP 的“停-等”协议，收到 Follower 确认后才更新 nextIndex，发送后面日志。其实可以改成流水线式的，不等前面日志确认就更新 nextIndex 继续发后面的。当然，如果后面发现之前日志同步出错，就要回退 nextIndex 重发之前日志——而原始版本 nextIndex 在**同步阶段**是单调递增的。
- **并行 append**：Leader 在 append 日志到本地前，就先发送日志给所有 Follower。

  
### raft 对网络有什么假设
- 网络是不可靠的: 可能会丢失 rpc 或者延迟
- 网络是有界的: 在一段时间内 rpc 总会到达, 如果还不到, 就认为是 rpc 丢失了



# gpt-4o 建议
当然，以下是对这些问题的大概参考答案或解答思路：

### 基本概念和理论

1. **Raft 算法的基本原理是什么？**
   - Raft 是一种共识算法，用于管理分布式系统中的日志复制。它通过选举一个领导者来协调日志的复制，确保所有节点都同意相同的日志条目。

2. **Raft 和 Paxos 有什么区别？为什么选择 Raft 而不是 Paxos？**
   - Raft 比 Paxos 更易于理解和实现。Raft 将共识过程分为领导者选举、日志复制和安全性三个部分，而 Paxos 的描述更抽象且复杂。选择 Raft 是因为它的清晰性和易用性。

3. **Raft 的三个主要状态是什么？**
   - Follower（追随者）
   - Candidate（候选人）
   - Leader（领导者）

4. **Raft 如何处理领导者选举？**
   - 当没有收到领导者的心跳信息时，Follower 转变为 Candidate，并发起选举。通过投票机制，获得多数票的 Candidate 成为新的 Leader。

5. **Raft 算法中的日志复制是如何实现的？**
   - Leader 将日志条目复制到所有 Follower 上，等待大多数 Follower 确认（即日志提交），然后通知所有 Follower 提交日志。

### 项目设计与架构

6. **你们的分布式键值存储系统是如何设计的？能画一下架构图吗？**
   - 描述系统的主要组件：客户端、路由器、存储节点（包含 Raft 模块）、协调器（用于分片管理）。

7. **为什么选择使用 Raft 来实现一致性？**
   - Raft 提供简单且可靠的一致性保证，易于实现和调试，适用于分布式系统的一致性需求。

8. **如何进行数据分片（Sharding）？**
   - 数据分片通过哈希函数将键分配到不同的分片，各分片分布在不同的节点上。

9. **数据分片后，如何保证各个分片的一致性？**
   - 每个分片内部使用独立的 Raft 集群来保证一致性。

10. **如何处理节点的加入和退出？**
    - 节点加入时，通过协调器更新分片分配表，并同步数据；节点退出时，协调器重新分配其分片，并将数据迁移到其他节点。

### 实现细节

11. **Raft 算法在你们项目中的具体实现步骤是怎样的？**
    - 实现步骤包括：节点启动、领导者选举、日志复制、日志提交、日志快照等。

12. **日志条目的结构是怎样的？**
    - 日志条目通常包含索引、任期、命令（操作和数据）等字段。

13. **如何处理 Raft 日志的压缩（Snapshotting）？**
    - 定期生成快照，将已提交的日志条目应用到状态机，并丢弃旧日志以节省存储空间。

14. **如何处理网络分区（Network Partition）？**
    - 网络分区时，少数派节点无法选举出新的领导者，等待网络恢复后重新同步。

15. **在高负载情况下，如何保证系统的高可用性？**
    - 通过负载均衡、增加副本数量和优化网络传输来提高系统的高可用性。

### 性能优化

16. **如何优化日志复制的性能？**
    - 使用批量复制、压缩日志条目、并行复制等技术。

17. **如何处理写入操作的高并发？**
    - 使用锁机制、队列或分布式事务来处理高并发写入操作。

18. **如何进行读写分离？**
    - 将读操作路由到 Follower 节点，写操作由 Leader 处理，确保数据一致性。

19. **有没有使用缓存？如果有，如何保持缓存的一致性？**
    - 使用缓存来加速读操作，通过缓存失效机制或订阅变更通知来保持一致性。

20. **你们是如何进行性能测试的？测试结果如何？**
    - 使用压力测试工具模拟高并发读写操作，监控系统性能指标，分析并优化系统。

### 故障处理与恢复

21. **系统中如何处理节点故障？**
    - 通过心跳检测识别故障节点，自动重新分配分片，恢复数据副本。

22. **Raft 算法如何保证在网络分区后的数据一致性？**
    - Raft 算法通过多数派原则保证一致性。即使网络分区，只要多数节点仍然可达，系统就能继续工作并保持一致性。

23. **如何处理领导者节点的故障？**
    - 当领导者节点故障时，Follower 节点会发现无法接收到心跳信息，触发新的选举过程，选出新的领导者。

24. **系统崩溃后如何进行数据恢复？**
    - 系统崩溃后，通过 Raft 日志和快照恢复数据。首先从快照恢复状态，然后重放日志条目以达到最新状态。

25. **如何检测并处理脑裂（Split-Brain）现象？**
    - 使用一致性算法（如 Raft）本身的多数派机制来避免脑裂，确保只有一个领导者。当出现脑裂时，次要分区无法选出领导者。

### 实际应用与扩展

26. **这个项目中遇到的最大挑战是什么？你是如何解决的？**
    - 例如：日志复制延迟导致的一致性问题。通过优化网络传输和日志压缩技术来解决。

27. **有哪些实际应用场景？**
    - 例如：分布式数据库、分布式缓存系统、配置管理系统等。

28. **如何处理大规模数据的分布式存储和访问？**
    - 通过数据分片、负载均衡、水平扩展等技术处理大规模数据。

29. **未来的改进方向有哪些？**
    - 例如：优化性能、增加更多的容错机制、提高系统的可扩展性和易用性。

30. **如果要扩展这个系统，你会考虑哪些方面？**
    - 考虑增加更多节点、改进数据分片算法、优化网络传输、增强系统的监控和管理功能。

这些答案是概要性的，具体回答时可以结合你在项目中的实际经验和遇到的问题，详细说明你的设计决策和实现细节。这不仅能展示你的技术能力，还能体现你对项目的深入理解。祝你面试成功！