# Rust program process memory layout

- 进程虚拟内存空间: ![[Pasted image 20240730124531.png]]

### `text`
- 文本段, 只读, 存放的是程序的指令, 跟 CPU 架构强相关

### `data`
- 数据段, 可读写, 存放的是 `初始化的 全局变量+局部静态变量`

### `bss`
- `block started by symbol`
- 存储的是未初始化的全局变量

### `stack`
- 每个线程都有一个栈, 函数调用和局部变量使用
- 进程的主线程在被创建出来之后, 会自动分配一个大小为 `8KB` 的栈 (不同的线程会有不同的栈大小, 其他辅助线程大小默认为 `2KB`, 也可以在发起线程时指定这个大小)
- 只有编译时占用内存大小确定的变量才可以在栈上分配
- 每一次函数调用中, 线程都会将该函数调用信息压入栈中, 形成一个栈帧, 函数调用结束之后, 该函数的栈帧就会被销毁
- 因此不能返回一个局部变量 (go 这种局部变量会逃逸的除外)
- 栈帧的创建和销毁只是简单的修改栈顶指针的位置而已, 相比在堆上申请空间需要系统调用, 栈分配非常快速

![[Pasted image 20240730125232.png]]

### `heap`
- 所有线程共享, 使用前需要先申请
- 由于程序的所有执行流(函数调用)都是在栈上进行的, 因此堆参与其中的方法就是栈上的变量引用堆中的对象 (指针) ![[Pasted image 20240730130226.png]]
- 由于栈上只保存对象的地址, 因此, 堆上的对象是可以被引用多次从而达到共享的
- 堆的内存初始时为空, 没有 os 物理内存与之对应, 如果要使用则需要向 os 申请
- os 通过 `brk(), sbrk()` 之类的系统调用为堆分配内存
- `rust` 可以自己选择内存分配器, 也可以使用 `libc` 动态链接库中的 `malloc` 作为分配器![[Pasted image 20240730130932.png]]
- 一般都不会直接每次向操作系统申请或返回内存, 而是本地做一定的暂存

### `mmap`
- 在栈和堆中间, 用来做 `mmap` 映射

### `CPU word size`
- `word size` 是 CPU 一次可以处理的数据大小
- 现代 CPU 通常都是 `64-bits`, 也就是 `word size = 8 Byte`


# Rust data types

### 基本数据类型
- 基本数据类型全都是在栈上数据类型
- `rust` 的基本数据类型大小非常直观, 就直接写在类型名称中 ![[Pasted image 20240730161028.png]]
- 需要注意的是, `rust` 原生支持 `unicode`, 因此 `char` 数据类型大小为 `4 Byte` ![[Pasted image 20240730161134.png]]


### `tuple`
- 元组在堆上还是在栈上取决与其中的元素类型
- 元组中的元素在内存中的位置紧密相连, 同时为了 CPU 效率, 通常会做 `align`, 内存对齐
![[Pasted image 20240730161558.png]]


### `reference`
- 引用数据类型, 就是指针, 大小固定为 `CPU word size`, 一般都是 `64-bit, 8 Byte`
- 可以引用栈上的变量, 也可以引用堆上的变量
![[Pasted image 20240730162818.png]]


### `array & vector & &[T]`
- 数组的类型跟数据类型, 数组长度有关
- 数组是否放在栈上取决于元素是否栈上类型
- 可变长度的 `vector` 则是将实际数据放在堆上, 元信息放在栈上
- 切片引用 `&[T]` 就像是 `array, vector` 的视图, 
- 注意: 切片在编译时长度不确定, 因此无法编译, 因此直接使用 `[T]`, 需要使用切片引用
- ![[Pasted image 20240730222645.png]]


### `String & str & &str`
- `rust` 中的字符串原生支持 `unicode::UTF-8`
- `String` 类型跟 `vector` 类似, 实际数据都是在堆上的, 栈上的内容只是一些元数据 `reference + cap + len`
![[Pasted image 20240730223448.png]]


### `struct`
- 结构体也是按照其中元素的类型决定存储位置, 空结构体不会分配内存
![[Pasted image 20240730223703.png]]
