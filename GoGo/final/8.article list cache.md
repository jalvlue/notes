redis 缓存数据结构:
![[Pasted image 20240416204956.png]]


这里主要针对的是 `article rpc` 中的 `articles` 方法, 根据用户 id 查询他的文章(查看该用户的历史发布文章)

主要的做法是

![[Pasted image 20240417150133.png]]
每次请求都带着一个 `cursor`, 记录上一次请求得到的末尾(第一次请求可以不用, 默认为 0)


1. 缓存中存储用户的文章 id, 使用 sorted list 存, 使用 id 作为 member, 使用排序方式作为 score
2. 每次请求都会根据用户 id 排序方式先查缓存, 如果缓存命中了, 说明之前已经请求过了, 并且已经将用户的所有文章 id 都已经排完序放进缓存中了, 从缓存中获取文章 id
3. 如果缓存没有命中, 则会从数据库中查用户的所有文章 id, 让后放进缓存中
4. 拿到了文章 id 之后, 就使用 `MapReduce` 并行拉取文章 (在指定的 `pageSize` 和 `cursor` 之内)然后将这些拉取到的文章放入 `curPage` 中, 返回给用户
5. 用户下次再请求时, 缓存一定会命中, 根据用户请求的 `cursor`, 使用 `MapReduce` 拉取下一页的文章返回即可

总而言之, 这里的重点就是缓存索引, 然后每次请求就都可以快速拿到索引, 然后根据索引到数据库里拉取文章(当然, 拉取文章也会有一层缓存)

